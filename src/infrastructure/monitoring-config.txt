global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

rule_files:
  - "/etc/prometheus/rules/*.yml"

scrape_configs:
  - job_name: 'extrastaff360_frontend'
    static_configs:
      - targets: ['frontend:3000']
    metrics_path: '/metrics'
    scheme: 'http'

  - job_name: 'extrastaff360_backend'
    static_configs:
      - targets: ['api:4000']
    metrics_path: '/metrics'
    scheme: 'http'

  - job_name: 'extrastaff360_database'
    static_configs:
      - targets: ['db:9104']
    metrics_path: '/metrics'
    scheme: 'http'

  - job_name: 'extrastaff360_cache'
    static_configs:
      - targets: ['redis:9121']
    metrics_path: '/metrics'
    scheme: 'http'

  - job_name: 'extrastaff360_ml_service'
    static_configs:
      - targets: ['ml_service:5000']
    metrics_path: '/metrics'
    scheme: 'http'

alerting_rules:
  groups:
    - name: availability
      rules:
        - alert: ServiceDown
          expr: up == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "Service {{ $labels.instance }} down"
            description: "Service has been down for more than 1 minute."

    - name: performance
      rules:
        - alert: HighLatency
          expr: http_request_duration_seconds{quantile="0.9"} > 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High latency on {{ $labels.instance }}"
            description: "90th percentile latency is above 1s for 5m."

    - name: database
      rules:
        - alert: HighConnectionCount
          expr: mysql_global_status_threads_connected > 100
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High DB connection count"
            description: "Database has high number of connections."

dashboards:
  - name: 'Platform Overview'
    uid: 'platform_overview'
    panels:
      - title: 'Request Rate'
        type: 'graph'
        datasource: 'prometheus'
        targets:
          - expr: 'rate(http_requests_total[5m])'
      
      - title: 'Error Rate'
        type: 'graph'
        datasource: 'prometheus'
        targets:
          - expr: 'rate(http_requests_errors_total[5m])'
      
      - title: 'Database Connections'
        type: 'gauge'
        datasource: 'prometheus'
        targets:
          - expr: 'mysql_global_status_threads_connected'
